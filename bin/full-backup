#!/usr/bin/env python3
#
# Full backup of iCloud Drive and Photos Library to an external drive
#

import subprocess
from pathlib import Path
from shutil import which


def backup_dirs(orig: Path, dest: Path) -> None:
    if which("rsync") is None:
        print("rsync not found in PATH")
        return

    orig_path = orig.expanduser().resolve().as_posix() + "/"
    dest_path = dest.expanduser().resolve().as_posix()

    print(f"Backing up '{orig_path}' â†’ '{dest_path}'")

    subprocess.run(
        [
            "rsync",
            "--compress",
            "--copy-links",
            "--delete",
            "--delete-excluded",
            "--exclude=.DS_Store",
            "--exclude=.Trash",
            "--itemize-changes",
            "--links",
            "--modify-window=2",
            "--numeric-ids",
            "--omit-dir-times",
            "--recursive",
            "--times",
            orig_path,
            dest_path,
        ],
        check=True,
    )


def backup_photos(photos_library: Path, dest: Path) -> None:
    if which("osxphotos") is None:
        print("osxphotos not found in PATH")
        return

    photos_db = photos_library.expanduser().as_posix()
    export_dir = dest.expanduser().as_posix()

    cmd = [
        "osxphotos",
        "export",
        export_dir,
        "--cleanup",
        "--convert-to-jpeg",
        "--jpeg-quality",
        "0.9",
        "--db",
        photos_db,
        "--directory",
        "{folder_album}",
        "--download-missing",
        "--edited-suffix",
        "",
        "--exiftool",
        "--exiftool-merge-keywords",
        "--exiftool-merge-persons",
        "--filename",
        "{created.strftime,%Y-%m-%d-%H%M%S}",
        "--ignore-date-modified",
        "--jpeg-ext",
        "jpg",
        "--not-hidden",
        "--retry",
        "5",
        "--person-keyword",
        "--skip-bursts",
        "--skip-live",
        "--skip-original-if-edited",
        "--skip-raw",
        "--theme",
        "dark",
        "--update",
    ]

    subprocess.run(cmd, check=True)


if __name__ == "__main__":
    backup_dirs(
        Path("~/Library/Mobile Documents/com~apple~CloudDocs/"),
        Path("/Volumes/Backups/Drive/"),
    )

    backup_dirs(
        Path("~/Library/Mobile Documents/iCloud~md~obsidian"),
        Path("/Volumes/Backups/Obsidian/"),
    )

    backup_photos(
        Path("~/Pictures/Photos Library.photoslibrary"),
        Path("/Volumes/Backups/Photos/"),
    )

# vim: set syntax=python:
